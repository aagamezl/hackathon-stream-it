(function(){const s=document.createElement("link").relList;if(s&&s.supports&&s.supports("modulepreload"))return;for(const t of document.querySelectorAll('link[rel="modulepreload"]'))e(t);new MutationObserver(t=>{for(const o of t)if(o.type==="childList")for(const i of o.addedNodes)i.tagName==="LINK"&&i.rel==="modulepreload"&&e(i)}).observe(document,{childList:!0,subtree:!0});function n(t){const o={};return t.integrity&&(o.integrity=t.integrity),t.referrerPolicy&&(o.referrerPolicy=t.referrerPolicy),t.crossOrigin==="use-credentials"?o.credentials="include":t.crossOrigin==="anonymous"?o.credentials="omit":o.credentials="same-origin",o}function e(t){if(t.ep)return;t.ep=!0;const o=n(t);fetch(t.href,o)}})();const Y=(r,s,n)=>{const e={x:0,y:0,width:s,height:n,maxX:r.cols*r.tsize-s,maxY:r.rows*r.tsize-n,following:null},t=i=>{e.following=i,i.screenX=0,i.screenY=0},o=()=>{let i=e.width/2,c=e.height/2;return e.x=e.following.x-e.width/2,e.y=e.following.y-e.height/2,e.x=Math.max(0,Math.min(e.x,e.maxX)),e.y=Math.max(0,Math.min(e.y,e.maxY)),(e.following.x<e.width/2||e.following.x>e.maxX+e.width/2)&&(i=e.following.x-e.x),(e.following.y<e.height/2||e.following.y>e.maxY+e.height/2)&&(c=e.following.y-e.y,c=e.following.y-e.y),{screenX:i,screenY:c}};return e.follow=t,e.update=o,e},z=3,I=5,X=[z,I],L=()=>{const r={cols:12,rows:12,tsize:64,layers:[[3,3,3,3,3,3,3,3,3,3,3,3,3,1,1,1,1,1,1,1,1,1,1,3,3,1,1,1,1,1,1,1,1,1,1,3,3,1,1,1,1,1,1,1,1,1,1,3,3,1,1,1,1,1,1,1,1,1,1,3,3,1,1,1,1,1,2,1,1,1,1,3,3,1,2,2,1,1,1,1,1,1,1,3,3,1,2,2,1,1,1,1,1,1,1,3,3,1,1,1,2,1,1,1,1,1,1,3,3,1,1,1,1,2,1,1,1,1,1,3,3,1,1,1,1,2,1,1,1,1,1,3,3,3,3,1,1,2,3,3,3,3,3,3],[4,3,3,3,3,3,3,3,3,3,3,4,4,0,0,0,0,0,0,0,0,0,0,4,4,0,0,0,0,0,0,0,0,0,0,4,4,0,0,5,0,0,0,0,0,5,0,4,4,0,0,0,0,0,0,0,0,0,0,4,4,0,0,0,0,0,0,0,0,0,0,4,4,0,0,0,0,0,0,0,0,0,0,4,4,0,0,0,0,0,0,0,0,0,0,4,4,0,0,0,0,0,0,0,0,0,0,4,4,0,0,0,0,0,0,0,0,0,0,4,4,4,4,0,5,4,4,4,4,4,4,4,4,4,4,0,0,3,3,3,3,3,3,3]]},s=(n,e,t)=>r.layers[n][t*r.cols+e];return{...r,getTile:s,isSolidTileAtXY:(n,e)=>{const t=Math.floor(n/r.tsize),o=Math.floor(e/r.tsize);return r.layers.reduce((i,c,l)=>{const a=s(l,t,o);return i||(a===z||a===I)},!1)},getCol:n=>Math.floor(n/r.tsize),getRow:n=>Math.floor(n/r.tsize),getX:n=>n*r.tsize,getY:n=>n*r.tsize}},h={images:{},getImage:r=>{if(!h.images[r])throw new Error(`Image ${r} not found`);return h.images[r]},loadImage:(r,s)=>new Promise((n,e)=>{const t=new Image;t.onload=()=>{h.images[r]=t,n(t)},t.onerror=()=>{e(new Error(`Failed to load image: ${s}`))},t.src=new URL(s,import.meta.url).href})},A=(r,s,n)=>{const e={map:r,x:s,y:n,width:32,height:64,image:h.getImage("hero"),speed:128,direction:"front",frame:0,animationTimer:0,animationSpeed:9,lastMovement:null},t=(i,c)=>{const l=e.x-e.width/2,a=e.x+e.width/2-1,d=e.y-e.height/2,m=e.y+e.height/2-1;(e.map.isSolidTileAtXY(l,d)||e.map.isSolidTileAtXY(a,d)||e.map.isSolidTileAtXY(a,m)||e.map.isSolidTileAtXY(l,m))&&(c>0?e.y=-e.height/2+e.map.getY(e.map.getRow(m)):c<0?e.y=e.height/2+e.map.getY(e.map.getRow(d)+1):i>0?e.x=-e.width/2+e.map.getX(e.map.getCol(a)):i<0&&(e.x=e.width/2+e.map.getX(e.map.getCol(l)+1)))},o=(i,c,l)=>{c>0?e.direction="right":c<0?e.direction="left":l>0?e.direction="front":l<0&&(e.direction="back"),c!==0||l!==0?(e.animationTimer+=i,e.animationTimer>=1/e.animationSpeed&&(e.animationTimer=0,e.frame=(e.frame+1)%3)):e.frame=0,e.x+=c*e.speed*i,e.y+=l*e.speed*i,t(c,l);const a=e.map.cols*e.map.tsize,d=e.map.rows*e.map.tsize;return e.x=Math.max(0,Math.min(e.x,a)),e.y=Math.max(0,Math.min(e.y,d)),{x:e.x,y:e.y}};return e.move=o,e},g={LEFT:37,RIGHT:39,UP:38,DOWN:40},b=r=>{const s=r.reduce((o,i)=>(o[i]=!1,o),{}),n=o=>{const i=o.keyCode;i in s&&(o.preventDefault(),s[i]=!0)},e=o=>{const i=o.keyCode;i in s&&(o.preventDefault(),s[i]=!1)};return{state:s,handleKeyDown:n,handleKeyUp:e,isDown:o=>{if(!(o in s))throw new Error(`Keycode ${o} is not being listened to`);return s[o]},listen:()=>{window.addEventListener("keydown",n),window.addEventListener("keyup",e)}}},v=(r,s,n)=>{const e={ctx:r,tileAtlas:null,heroImage:null,grid:s,keyboard:n,camera:null,hero:null,heroSpeed:256,previousTime:0},t=l=>{const a=Math.floor(e.camera.x/e.grid.tsize),d=a+e.camera.width/e.grid.tsize,m=Math.floor(e.camera.y/e.grid.tsize),f=m+e.camera.height/e.grid.tsize,M=-e.camera.x+a*e.grid.tsize,T=-e.camera.y+m*e.grid.tsize;for(let u=a;u<=d;u++)for(let w=m;w<=f;w++){const y=e.grid.getTile(l,u,w),p=(u-a)*e.grid.tsize+M,x=(w-m)*e.grid.tsize+T;y!==0&&(e.ctx.drawImage(e.tileAtlas,(y-1)*e.grid.tsize,0,e.grid.tsize,e.grid.tsize,Math.round(p),Math.round(x),e.grid.tsize,e.grid.tsize),X.includes(y)&&r.strokeRect(p,x,e.grid.tsize,e.grid.tsize))}},o=l=>{window.requestAnimationFrame(o),r.clearRect(0,0,512,512);const a=Math.min((l-e.previousTime)/1e3,.25);e.previousTime=l,c(a),i()},i=()=>{t(0);const a={front:0,left:1,right:2,back:3}[e.hero.direction],d=e.hero.frame*e.hero.width,m=a*e.hero.height;e.ctx.drawImage(e.hero.image,d,m,e.hero.width,e.hero.height,e.hero.screenX-e.hero.width/2,e.hero.screenY-e.hero.height/2,e.hero.width,e.hero.height),r.strokeRect(e.hero.x-e.hero.width/2-e.camera.x,e.hero.y-e.hero.height/2-e.camera.y,e.hero.width,e.hero.height),t(1)},c=l=>{let a=0,d=0;e.keyboard.isDown(g.LEFT)?a=-1:e.keyboard.isDown(g.RIGHT)?a=1:e.keyboard.isDown(g.UP)?d=-1:e.keyboard.isDown(g.DOWN)&&(d=1),e.hero.move(l,a,d);const{screenX:m,screenY:f}=e.camera.update();return e.hero.screenX=m,e.hero.screenY=f,e};return{state:e,run:()=>{e.keyboard.listen(),e.hero=A(e.grid,160,160),e.camera=Y(e.grid,512,512),e.camera.follow(e.hero),window.requestAnimationFrame(o)},loadAssets:()=>Promise.all([h.loadImage("tiles","./../assets/tileset.png"),h.loadImage("hero","./../assets/mark.png")]).then(([l,a])=>(e.tileAtlas=l,e.heroImage=a,e))}};window.onload=()=>{const s=document.getElementById("demo").getContext("2d"),n=L(),e=b(Object.values(g)),t=v(s,n,e);t.loadAssets().then(()=>{t.run()})};
